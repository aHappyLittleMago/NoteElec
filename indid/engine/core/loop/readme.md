# GameLoop 模块说明


## 模块简介
`GameLoop` 是游戏引擎的核心循环管理器，负责协调游戏逻辑更新（Update）与画面渲染（Render）的时序，提供稳定、可控的游戏运行周期。通过封装浏览器的动画帧机制，简化游戏循环的实现复杂度，同时支持丰富的扩展功能，适配从简单小游戏到复杂场景的需求。


## 核心功能
1. **基础循环控制**  
   - 支持循环的启动（`start`）与完全停止（`stop`），停止后需重新启动才能恢复。  
   - 支持暂停（`pause`）与恢复（`resume`），暂停时保留当前状态，恢复后继续运行（避免时间差突变）。

2. **多回调管理**  
   - 支持注册多个更新回调（`addUpdateCallback`）：用于处理游戏逻辑（如角色移动、碰撞检测），每个回调接收帧时间差（`deltaTime`，秒级）。  
   - 支持注册多个渲染回调（`addRenderCallback`）：用于处理画面绘制（如实体渲染、UI更新）。  
   - 提供回调移除机制：每个注册方法返回移除函数，方便在组件卸载或场景切换时清理资源，避免内存泄漏。

3. **帧率控制**  
   - 支持设置最大帧率（`setMaximumFps`）：限制游戏运行的最高帧率（如30FPS），减少不必要的性能消耗。  
   - 自动适配浏览器刷新频率：基于 `requestAnimationFrame` 实现，默认跟随浏览器刷新率（通常60FPS）。

4. **时间稳定性保障**  
   - 帧时间差（`deltaTime`）计算：自动计算每帧间隔时间（转换为秒），用于统一不同设备上的逻辑速度（如移动距离 = 速度 × deltaTime）。  
   - 时间差限制：避免页面隐藏、浏览器卡顿后恢复时，`deltaTime` 过大导致逻辑异常（最大限制为0.2秒）。  
   - 暂停时间修正：恢复循环时自动剔除暂停期间的时间，确保逻辑时间连续。

5. **错误处理与监控**  
   - 回调错误捕获：所有更新/渲染回调执行时自动捕获错误，避免单个回调异常导致整个循环崩溃。  
   - 错误回调机制：通过 `onError` 注册全局错误处理器，统一处理游戏逻辑中的异常。  
   - 实时帧率监控：内置 `currentFps` 属性，每秒更新当前帧率，方便调试和性能优化。


## 功能实现核心概述
1. **循环驱动**  
   基于浏览器 `requestAnimationFrame` 实现递归调用，每帧触发一次核心循环函数（`#loop`）。通过 `isRunning` 状态控制循环启停，`isPaused` 状态控制逻辑/渲染是否执行。

2. **时间计算**  
   - 基于 `performance.now()` 获取高精度时间戳，计算当前帧与上一帧的时间差（`elapsed`）。  
   - 帧率限制通过比较 `elapsed` 与目标帧间隔（`1000ms / 最大帧率`）实现，不足则跳过当前帧。  
   - 暂停恢复时，通过记录暂停开始时间，修正 `lastTime`（加上暂停时长），确保 `deltaTime` 连续。

3. **回调管理**  
   - 维护 `updateCallbacks` 和 `renderCallbacks` 数组存储多个回调，每帧遍历执行（带错误捕获）。  
   - 回调移除通过过滤数组实现，确保移除后不再执行目标回调。

4. **帧率计算**  
   每帧递增帧计数器，每秒（`1000ms`）计算一次帧率（`帧率 = 帧数 / 秒数`），并更新 `currentFps` 属性。


## 简单使用示例
```typescript
// 1. 初始化循环实例
const loop = new GameLoop();

// 2. 注册更新回调（逻辑处理）
const removeUpdate = loop.addUpdateCallback((deltaTime) => {
  // 例如：角色移动（速度×时间差，确保不同帧率下移动距离一致）
  player.x += player.speed * deltaTime;
});

// 3. 注册渲染回调（画面绘制）
const removeRender = loop.addRenderCallback(() => {
  renderer.clear();
  renderer.draw(player);
});

// 4. 启动循环
loop.start();

// 5. 场景切换/组件卸载时清理
const cleanup = () => {
  removeUpdate(); // 移除更新回调
  removeRender(); // 移除渲染回调
  loop.stop(); // 停止循环
};
```


## 注意事项
- 回调函数应避免同步阻塞操作，以免影响循环流畅度。  
- 暂停/恢复适用于临时中断（如弹窗），完全停止（`stop`）适用于场景切换或游戏结束。  
- 最大帧率设置不宜低于30FPS，否则可能导致画面卡顿。